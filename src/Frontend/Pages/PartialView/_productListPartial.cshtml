@using Frontend.Common;
@using Frontend.Models;

@model PaginatedResult<Product>

@{
    var apiUrl = ViewData["ApiUrl"];
}


<div class="row g-0">
    @if (Model.Data.Any())
    {
        <div class="col-md-12">
            <span
                class="fw-bold mt-3 mb-5 fs-6">showing @((Model.CurrentPage - 1) * Model.PageSize + 1) - @((Model.CurrentPage - 1) * Model.PageSize + Model.Data.Count) of @Model.TotalItems results</span>
        </div>
        foreach (var product in Model.Data)
        {
            <div class="col-md-3">

                <div class="card ">
                    <div>
                        <img src="@(product.ImageUrl ?? Url.Content("~/assets/img/drone.png"))" alt="@product.Name"
                             class="card-img-top w-100" style="height: 200px; object-fit: contain;"/>
                    </div>


                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">@product.Name</h5>

                        <div class="mb-2">
                            <span class="fw-bold text-success">$@product.OriginalPrice</span>
                            @if (product.DiscountPercentage.HasValue && product.DiscountPercentage > 0 && product.IsDiscounted)
                            {
                                <span class="text-muted text-decoration-line-through ms-2">
                                    $@(Math.Round(product.OriginalPrice / (1 - product.DiscountPercentage.Value / 100), 2))
                                </span>
                            }
                        </div>

                        <div class="mt-auto">
                            @* @if (Model.Cart.ContainsKey(product.Id)) *@
                            @if (true)
                            {
                                <button class="btn btn-primary decreaseCartBtn" data-product-id="@product.Id">-</button>
                                <span class="btn btn-light btn-primary">2</span>
                                <button class="btn btn-primary increaseCartBtn" data-product-id="@product.Id">+</button>
                            }
                            else
                            {
                                <button class="btn border increaseCartBtn" data-product-id="@product.Id">Add to cart</button>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <p class="text-center">No products found.</p>
    }
</div>

<script src="lib/jquery/dist/jquery.min.js"></script>
<script>

    $(document).ready(function () {
        let decreaseBtn = document.getElementsByClassName("decreaseCartBtn");

        for (let i = 0; i < decreaseBtn.length; i++) {
            decreaseBtn[i].onclick = function () {
                let productId = this.dataset.productId;

                decreaseCartItem(productId)
            };
        }
        
        let addOrIncreaseBtn = document.getElementsByClassName("increaseCartBtn");

        for (let i = 0; i < addOrIncreaseBtn.length; i++) {
            addOrIncreaseBtn[i].onclick = function () {
                let productId = this.dataset.productId;

                addOrIncreaseCartItem(productId)
            };
        }
    });


</script>

<script>

    async function addOrIncreaseCartItem(productId) {
        const apiUrl = '@apiUrl';
        const url = `${apiUrl}/cart/increase/${productId}`;

        return $.ajax({
            url: url,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ productId: productId, quantity: 1 }),
        })
            .done(function () {
                alert('Quantity increased successfully');
            })
            .fail(function () {
                alert('Failed to increase quantity');
            });

    }

    async function decreaseCartItem(productId) {
        const apiUrl = '@apiUrl';
        const url = `${apiUrl}/cart/decrease/${productId}`;


        return $.ajax({
            url: url,
            type: 'DELETE',
            contentType: 'application/json',
        })
            .done(function () {
                alert('Quantity decreased successfully');
            })
            .fail(function () {
                alert('Failed to decrease quantity');
            });

    }


</script>

